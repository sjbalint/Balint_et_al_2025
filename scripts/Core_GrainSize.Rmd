---
title: "Core_GrainSIze"
author: "Balint"
date: "9/9/2021"
output: 
  html_document:
    code_folding: hide
    theme: cerulean
    word_document: default
---
```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

Import Data:

```{r}
#load libraries
library(readxl)
library(dplyr)

#import data
all_cores <- read_excel("data/grainsize_tidy.xlsx")

#remove replicate information
all_cores[c(2,4:5)] <- NULL

```

Next, we will try to make grainsize distribution plots using G2Sd:

```{r}
library(G2Sd)
library(tidyverse)
library(xlsx)

#create a list of cores
core_list <- c("North", "Middle", "South")

#iterate over list
for (i in core_list){
  temp_df <- subset(all_cores,Location==i)
  temp_df[1] <- NULL
  temp_df <- aggregate(temp_df,list(temp_df$Depth),mean)
  depths <- temp_df$Depth
  temp_df[1:3] <- NULL
  temp_df <- as.data.frame(t(temp_df))
  colnames(temp_df) <- depths
  grandistrib(temp_df,main=i,xlab="Depth")
  #write.xlsx2(temp_df, paste0(filepath,"grainsize_wide.xlsx"), sheetName = i, col.names = TRUE, row.names = TRUE, append = TRUE)
}

```

```{r}
library(xlsx)

write.xlsx2(temp_df, paste0(filepath,"grainsize_wide.xlsx"), sheetName = "Sheet1",
  col.names = TRUE, row.names = TRUE, append = FALSE)

```

The plots looks compelling and informative. However, I'd like to make them from scratch to modify the grain-size classes and orientation of the figure. First, we need to convert the data to a long format and classify it:

```{r}
library(tidyverse)
#create a list of cores
size_classes <- c("Clay","V.F. Silt","F. Silt","M. Silt","C. Silt","V.C. Silt","V.F. Sand","F. Sand","Sand","C. Sand","V.C. Sand","V.F. Gravel")

grainsizes <- data.frame(size_classes,c(2,4,8,16,31,62,125,250,500,1000,2000,4000))

colnames(grainsizes) <- c("Classification","Micrometers")

core_list <- c("North", "Middle", "South")

all_cores_class <- data.frame(matrix(nrow=0,ncol=6))

#iterate over list
for (i in core_list){
  temp_df <- subset(all_cores,Location==i)
  temp_df[1] <- NULL  
  temp_df <- aggregate(temp_df,list(temp_df$Depth),mean)
  temp_df[1] <- NULL
  temp_df <- pivot_longer(temp_df,!Depth,names_to="Grainsize",values_to="Percentage")
  temp_df$Grainsize <- as.numeric(as.character(temp_df$Grainsize))
  temp_df$Class <- NA
  for (x in 1:nrow(temp_df)){
    for (y in 1:nrow(grainsizes)){
      if (temp_df$Grainsize[x]<grainsizes[y,2]){
        temp_df$Class[x] <- grainsizes[y,1]
        break
      }
    }
  }
  temp_df$Location <- i
  if (i == "North"){
    temp_df$Core <- "AC2"
  }
  if (i == "Middle"){
    temp_df$Core <- "M6"
  }
  if (i == "South"){
    temp_df$Core <- "S3"
  }
  all_cores_class <- rbind(all_cores_class,temp_df)
  all_cores_class$Class <- factor(all_cores_class$Class,
                                  levels=size_classes)
  all_cores_class$Location <- factor(all_cores_class$Location,
                                  levels=c("North","Middle","South"))
}
```

Export the data to an excel sheet:

```{r}
library(xlsx)

write.xlsx2(all_cores_class, paste0(filepath,"grainsize_long.xlsx"), sheetName = "Sheet1",
  col.names = TRUE, row.names = TRUE, append = FALSE)

```

Create a graph of grainsize distribution for all three cores:

```{r}
library(RColorBrewer)

theme_set(theme_bw())

ggplot(all_cores_class, aes(x=Depth,y=Percentage, fill=Class))+
  geom_bar(position="fill",stat="identity",width=2)+
  coord_flip()+
  #scale_x_reverse(labels=function(x)2020-(x*3))+
  scale_x_reverse()+
  scale_y_continuous(labels=function(y)y*100)+
  scale_fill_brewer(palette="Spectral")+
  facet_wrap(~Location)+
  theme(strip.background = element_blank())+
  xlab("Depth (cm)")

ggsave("figures/grainsize.png",width=8, height=4.5)

```